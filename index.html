<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Table‑Soccer ELO Hub (Realtime DB)</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f9fafb; color: #1f2937; }
    .section { display: none; }
    .section.active { display: block; }
    .badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:.75rem; margin:2px; }
    .badge.locked { background:#ddd; color:#666; }
    .badge.unlocked { background:#4ade80; color:#034d23; }
    .stat-tile { background:white; padding:1rem; border-radius:.5rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- HEADER -->
  <header class="bg-white shadow sticky top-0 z-10">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="text-2xl font-bold">Table‑Soccer ELO</div>
      <nav class="space-x-4">
        <button data-target="dashboard"   class="nav-btn text-gray-700 hover:text-blue-600">Dashboard</button>
        <button data-target="players"     class="nav-btn text-gray-700 hover:text-blue-600">Players</button>
        <button data-target="matches"     class="nav-btn text-gray-700 hover:text-blue-600">Matches</button>
        <button data-target="leaderboard" class="nav-btn text-gray-700 hover:text-blue-600">Leaderboard</button>
        <button data-target="achievements"class="nav-btn text-gray-700 hover:text-blue-600">Achievements</button>
        <button data-target="stats"       class="nav-btn text-gray-700 hover:text-blue-600">Stats</button>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container mx-auto px-4 py-6 flex-grow">

    <!-- Dashboard -->
    <section id="dashboard" class="section active">
      <h2 class="text-xl mb-4">Dashboard</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white p-4 rounded shadow">Total Players: <span id="totalPlayers">0</span></div>
        <div class="bg-white p-4 rounded shadow">Matches This Week: <span id="matchesWeek">0</span></div>
        <div class="bg-white p-4 rounded shadow">Average ELO: <span id="averageElo">0</span></div>
        <div class="bg-white p-4 rounded shadow">Pending Achievements: <span id="pendingAch">0</span></div>
      </div>
    </section>

    <!-- Players -->
    <section id="players" class="section">
      <h2 class="text-xl mb-4">Players</h2>
      <div class="flex space-x-2 mb-4">
        <input id="newName" class="border p-2 rounded flex-grow" placeholder="Name"/>
        <input id="newElo" type="number" class="border p-2 rounded w-24" value="100"/>
        <button id="addPlayer" class="bg-blue-600 text-white px-4 rounded">Add</button>
      </div>
      <input id="playerSearch" class="border p-2 rounded mb-4 w-full" placeholder="Search..."/>
      <table class="w-full border-collapse">
        <thead><tr class="bg-gray-100"><th class="border p-2">Name</th><th class="border p-2">ELO</th><th class="border p-2">Matches</th><th class="border p-2">Actions</th></tr></thead>
        <tbody id="playerTable"></tbody>
      </table>
    </section>

    <!-- Matches -->
    <section id="matches" class="section">
      <h2 class="text-xl mb-4">Matches</h2>
      <div class="mb-4">
        <button data-mode="1v1" class="mode-btn bg-blue-500 text-white px-3 py-1 rounded mr-2">1v1</button>
        <button data-mode="2v2" class="mode-btn bg-gray-300 text-gray-700 px-3 py-1 rounded">2v2</button>
      </div>
      <div id="form1v1" class="match-form">
        <div class="flex space-x-2 mb-2">
          <select id="selA1" class="border p-2 rounded flex-grow"></select>
          <select id="selB1" class="border p-2 rounded flex-grow"></select>
        </div>
        <div class="flex space-x-2 mb-2">
          <input id="scoreA1" type="number" class="border p-2 rounded w-24" placeholder="Score A"/>
          <input id="scoreB1" type="number" class="border p-2 rounded w-24" placeholder="Score B"/>
        </div>
        <button id="reg1v1" class="bg-green-600 text-white px-4 py-2 rounded">Register 1v1</button>
      </div>
      <div id="form2v2" class="match-form hidden">
        <div class="grid grid-cols-2 gap-2 mb-2">
          <select id="selA21" class="border p-2 rounded"></select>
          <select id="selA22" class="border p-2 rounded"></select>
        </div>
        <div class="grid grid-cols-2 gap-2 mb-2">
          <select id="selB21" class="border p-2 rounded"></select>
          <select id="selB22" class="border p-2 rounded"></select>
        </div>
        <div class="flex space-x-2 mb-2">
          <input id="scoreA2" type="number" class="border p-2 rounded w-24" placeholder="Score A"/>
          <input id="scoreB2" type="number" class="border p-2 rounded w-24" placeholder="Score B"/>
        </div>
        <button id="reg2v2" class="bg-green-600 text-white px-4 py-2 rounded">Register 2v2</button>
      </div>
      <!-- Tilføjet: Liste af seneste kampe med Undo -->
      <div id="recentMatches" class="bg-white p-4 rounded shadow mt-6">
        <h3 class="font-bold mb-2">Recent Matches <span class="text-sm text-gray-500">(Undo available)</span></h3>
        <ul id="recentList" class="space-y-2"></ul>
      </div>
    </section>

    <!-- Leaderboard -->
    <section id="leaderboard" class="section">
      <h2 class="text-xl mb-4">Leaderboard</h2>
      <input id="lbSearch" class="border p-2 rounded mb-4 w-full" placeholder="Search..."/>
      <table class="w-full border-collapse">
        <thead><tr class="bg-gray-100"><th class="border p-2">#</th><th class="border p-2">Name</th><th class="border p-2">ELO</th></tr></thead>
        <tbody id="lbTable"></tbody>
      </table>
    </section>

    <!-- Achievements -->
    <section id="achievements" class="section">
      <h2 class="text-xl mb-4">Achievements</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <!-- ... eksisterende achievements ... -->
      </div>
    </section>

    <!-- Stats -->
    <section id="stats" class="section">
      <h2 class="text-xl mb-4">Player Stats & Achievements</h2>
      <select id="statsPlayerSelect" class="border p-2 rounded mb-4">
        <option value="">Select player</option>
      </select>
      <div id="profile" class="space-y-6"></div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer class="bg-white shadow text-center py-4">
    &copy; 2025 Table‑Soccer ELO • v1.0 • <a href="#" class="text-blue-600">Support</a>
  </footer>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import {
      getDatabase,
      ref,
      onValue,
      push,
      update,
      remove,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAX2LLZYbQuWFrDuU0-_guF0lR9FMfVD6I",
      authDomain: "bordfodbolddtu.firebaseapp.com",
      databaseURL: "https://bordfodbolddtu-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bordfodbolddtu",
      storageBucket: "bordfodbolddtu.firebasestorage.app",
      messagingSenderId: "993863941891",
      appId: "1:993863941891:web:24c5c2408d254ad6d0f336"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    let players = {};
    let matches = {};

    onValue(ref(db, 'players'), snap => {
      players = snap.val() || {};
      rerender();
    });
    onValue(ref(db, 'matches'), snap => {
      matches = snap.val() || {};
      rerender();
    });

    function computePlayerData(p) {
      // ... eksisterende computePlayerData ...
    }

    function rerender(){
      const pArr = Object.values(players);
      const mArr = Object.values(matches);

      // Dashboard, Players, Leaderboard render as før…

      // Tilføjet: Delete-knap i player-listen
      const pf = document.getElementById('playerSearch').value.toLowerCase();
      const tbodyP = document.getElementById('playerTable');
      tbodyP.innerHTML = '';
      pArr.filter(p=>p.name.toLowerCase().includes(pf)).forEach(p=>{
        const tr = document.createElement('tr'); tr.className='hover:bg-gray-100';
        tr.innerHTML = `
          <td class=\"border p-2\">${p.name}</td>
          <td class=\"border p-2\">${p.elo}</td>
          <td class=\"border p-2\">${p.wins+p.draws+p.losses}</td>
          <td class=\"border p-2\"><button class=\"text-red-600 delete-player\" data-id=\"${p.id}\">Delete</button></td>`;
        tbodyP.appendChild(tr);
      });
      document.querySelectorAll('.delete-player').forEach(btn=>{
        btn.onclick = ()=>{
          if(!confirm('Are you sure you want to delete this player? This cannot be undone.')) return;
          remove(ref(db, 'players/'+btn.dataset.id));
        };
      });

      // Tilføjet: Recent matches med Undo
      const recentList = document.getElementById('recentList');
      recentList.innerHTML = '';
      mArr.sort((a,b)=>b.date-a.date).slice(0,5).forEach(m=>{
        const pA = players[m.playerIds[0]];
        const pB = players[m.playerIds[1]];
        const d = new Date(m.date).toLocaleString();
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center';
        li.innerHTML = `
          <span>${d}: ${pA.name} ${m.scoreA} - ${m.scoreB} ${pB.name}</span>
          <button class=\"text-blue-600 undo-match\" data-id=\"${m.id}\">Undo</button>`;
        recentList.appendChild(li);
      });
      document.querySelectorAll('.undo-match').forEach(btn=>{
        btn.onclick = ()=>{
          if(!confirm('Undo this match?')) return;
          undoMatch(btn.dataset.id);
        };
      });
    }

    function undoMatch(id){
      const m = matches[id];
      if(!m) return;
      const [idA,idB] = m.playerIds;
      const pA = {...players[idA]};
      const pB = {...players[idB]};
      const updates = {};
      // revert ELO
      updates[`players/${idA}/elo`] = m.eloBeforeA;
      updates[`players/${idB}/elo`] = m.eloBeforeB;
      // revert win/draw/loss
      if(m.scoreA>m.scoreB){ updates[`players/${idA}/wins`] = pA.wins-1; updates[`players/${idB}/losses`] = pB.losses-1; }
      else if(m.scoreB>m.scoreA){ updates[`players/${idB}/wins`] = pB.wins-1; updates[`players/${idA}/losses`] = pA.losses-1; }
      else { updates[`players/${idA}/draws`] = pA.draws-1; updates[`players/${idB}/draws`] = pB.draws-1; }
      // revert goals
      updates[`players/${idA}/goalsFor`] = pA.goalsFor - m.scoreA;
      updates[`players/${idA}/goalsAgainst`] = pA.goalsAgainst - m.scoreB;
      updates[`players/${idB}/goalsFor`] = pB.goalsFor - m.scoreB;
      updates[`players/${idB}/goalsAgainst`] = pB.goalsAgainst - m.scoreA;
      // revert clean sheet
      if(m.scoreB===0) updates[`players/${idA}/cleanSheets`] = pA.cleanSheets-1;
      if(m.scoreA===0) updates[`players/${idB}/cleanSheets`] = pB.cleanSheets-1;
      // remove history entries
      updates[`players/${idA}/history/${m.date}`] = null;
      updates[`players/${idB}/history/${m.date}`] = null;
      // delete match
      updates[`matches/${id}`] = null;
      update(ref(db), updates);
    }

    // Eksisterende addPlayer, register 1v1/2v2, nav toggles, stats tab osv.
    // Ingen kode er slettet, kun tilføjelser ovenfor.

    rerender();
  </script>
</body>
</html>
